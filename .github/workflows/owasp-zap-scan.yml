name: OWASP ZAP Security Scan

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # Run full scan nightly at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:

# Restrict top-level permissions (jobs define their own)
permissions: {}

jobs:
  zap-baseline-scan:
    name: ZAP Baseline Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.11'

      - name: Set up PDM
        uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
        with:
          python-version: '3.11'

      - name: Install system dependencies for SQLCipher
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev

      - name: Install dependencies
        run: |
          pdm sync -d

      - name: Start LDR server for testing
        run: |
          export CI=true
          export LDR_USE_FALLBACK_LLM=true
          export PYTHONPATH=$PWD/src:$PYTHONPATH
          pdm run python -m local_deep_research.web.app > server.log 2>&1 &
          SERVER_PID=$!
          echo "$SERVER_PID" > server.pid

          # Wait for server to start
          for _ in {1..30}; do
            if curl -s http://localhost:5000/api/v1/health > /dev/null; then
              echo "Server started successfully"
              break
            fi
            sleep 1
          done

          # Verify server is running
          if ! curl -s http://localhost:5000/api/v1/health > /dev/null; then
            echo "Server failed to start"
            cat server.log
            exit 1
          fi

      - name: Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@de8ad967d3548d44ef623df22cf95c3b0baf8b25 # v0.15.0
        continue-on-error: true  # Ignore artifact upload failures (we upload manually)
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: false
          fail_action: false
          artifact_name: zapbaseline

      - name: Upload ZAP scan results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: zap-baseline-scan-results
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill "$(cat server.pid)" || true
            rm server.pid
          fi

  zap-full-scan:
    name: ZAP Full Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.11'

      - name: Set up PDM
        uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
        with:
          python-version: '3.11'

      - name: Install system dependencies for SQLCipher
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev

      - name: Install dependencies
        run: |
          pdm sync -d

      - name: Start LDR server for testing
        run: |
          export CI=true
          export LDR_USE_FALLBACK_LLM=true
          export PYTHONPATH=$PWD/src:$PYTHONPATH
          pdm run python -m local_deep_research.web.app > server.log 2>&1 &
          SERVER_PID=$!
          echo "$SERVER_PID" > server.pid

          # Wait for server to start
          for _ in {1..30}; do
            if curl -s http://localhost:5000/api/v1/health > /dev/null; then
              echo "Server started successfully"
              break
            fi
            sleep 1
          done

          # Verify server is running
          if ! curl -s http://localhost:5000/api/v1/health > /dev/null; then
            echo "Server failed to start"
            cat server.log
            exit 1
          fi

      - name: Run ZAP Full Scan
        uses: zaproxy/action-full-scan@3c58388149901b9a03b7718852c5ba889646c27c # v0.13.0
        continue-on-error: true  # Ignore artifact upload failures (we upload manually)
        with:
          target: 'http://localhost:5000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: false
          fail_action: false
          artifact_name: zapfull

      - name: Upload ZAP full scan results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: zap-full-scan-results
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 90

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill "$(cat server.pid)" || true
            rm server.pid
          fi

  zap-api-scan:
    name: ZAP API Scan
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Set up Python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
        with:
          python-version: '3.11'

      - name: Set up PDM
        uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
        with:
          python-version: '3.11'

      - name: Install system dependencies for SQLCipher
        run: |
          sudo apt-get update
          sudo apt-get install -y libsqlcipher-dev

      - name: Install dependencies
        run: |
          pdm sync -d

      - name: Start LDR server for testing
        run: |
          export CI=true
          export LDR_USE_FALLBACK_LLM=true
          export PYTHONPATH=$PWD/src:$PYTHONPATH
          pdm run python -m local_deep_research.web.app > server.log 2>&1 &
          SERVER_PID=$!
          echo "$SERVER_PID" > server.pid

          # Wait for server to start
          for _ in {1..30}; do
            if curl -s http://localhost:5000/api/v1/health > /dev/null; then
              echo "Server started successfully"
              break
            fi
            sleep 1
          done

          # Verify server is running
          if ! curl -s http://localhost:5000/api/v1/health > /dev/null; then
            echo "Server failed to start"
            cat server.log
            exit 1
          fi

      - name: Generate OpenAPI specification
        run: |
          # If you have an OpenAPI spec, use it. Otherwise, ZAP will discover endpoints
          # For now, we'll let ZAP discover API endpoints automatically
          echo "Using automatic API endpoint discovery"

      - name: Run ZAP API Scan
        uses: zaproxy/action-api-scan@5158fe4d9d8fcc75ea204db81317cce7f9e5453d # v0.10.0
        continue-on-error: true  # Ignore artifact upload failures (we upload manually)
        with:
          target: 'http://localhost:5000/api/v1'
          format: 'openapi'
          cmd_options: '-a'
          allow_issue_writing: false
          fail_action: false
          artifact_name: zapapi

      - name: Upload ZAP API scan results
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: zap-api-scan-results
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30

      - name: Stop server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill "$(cat server.pid)" || true
            rm server.pid
          fi
