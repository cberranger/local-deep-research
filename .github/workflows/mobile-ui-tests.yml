name: Mobile UI Tests

on:
  push:
    branches: [ main, dev, 'fix/*', 'feature/*' ]
    paths:
      - 'src/local_deep_research/web/static/css/**'
      - 'src/local_deep_research/web/static/js/**'
      - 'src/local_deep_research/web/templates/**'
      - 'tests/ui_tests/**'
      - '.github/workflows/mobile-ui-tests.yml'
  pull_request:
    branches: [ main, dev ]
    paths:
      - 'src/local_deep_research/web/static/css/**'
      - 'src/local_deep_research/web/static/js/**'
      - 'src/local_deep_research/web/templates/**'
      - 'tests/ui_tests/**'
  workflow_dispatch:

permissions:
  contents: read
  checks: write

jobs:
  mobile-ui-tests:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
    - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install PDM
      run: |
        pip install --upgrade pip
        pip install pdm

    - name: Install Python dependencies
      run: |
        pdm install -d

    - name: Setup Node.js
      uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tests/ui_tests/package.json

    - name: Install Node dependencies
      working-directory: tests/ui_tests
      run: |
        npm ci
        npx puppeteer browsers install chrome

    - name: Setup test directories
      run: |
        mkdir -p data/encrypted_databases
        echo "Created data directories for tests"

    - name: Start LDR server
      run: |
        export LDR_DATA_DIR="$PWD/data"
        export PYTHONPATH="$PWD/src:$PYTHONPATH"
        export DISABLE_RATE_LIMITING=true
        echo "Starting server with LDR_DATA_DIR=$LDR_DATA_DIR"
        echo "Rate limiting disabled for CI tests"
        LDR_DATA_DIR="$PWD/data" PYTHONPATH="$PWD/src:$PYTHONPATH" DISABLE_RATE_LIMITING=true pdm run python -m local_deep_research.web.app &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> "$GITHUB_ENV"

        # Wait for server to be ready
        for i in {1..30}; do
          if curl -s http://127.0.0.1:5000 > /dev/null; then
            echo "Server is ready"
            break
          fi
          echo "Waiting for server... ($i/30)"
          sleep 2
        done

        # Verify server is running
        if ! curl -s http://127.0.0.1:5000 > /dev/null; then
          echo "Server failed to start"
          exit 1
        fi

    - name: Run Mobile Navigation Tests
      working-directory: tests/ui_tests
      env:
        HEADLESS: true
        OUTPUT_FORMAT: junit
        SCREENSHOT_ON_FAILURE: true
        TEST_BASE_URL: http://127.0.0.1:5000
      run: |
        node mobile/test_mobile_navigation_ci.js

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          tests/ui_tests/test-results.xml
          tests/ui_tests/test-results.json
          tests/ui_tests/test-failures/

    - name: Publish Test Results
      if: always() && matrix.python-version == '3.12'
      uses: EnricoMi/publish-unit-test-result-action@34d7c956a59aed1bfebf31df77b8de55db9bbaaf # v2.21.0
      with:
        files: tests/ui_tests/test-results.xml
        check_name: Mobile UI Test Results
        comment_mode: off

    - name: Stop server
      if: always()
      run: |
        if [ -n "$SERVER_PID" ]; then
          kill "$SERVER_PID" || true
        fi
        pkill -f "python -m local_deep_research.web.app" || true
