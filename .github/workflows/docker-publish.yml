name: Publish Docker image

on:
  release:
    types: [created]
  repository_dispatch:
    types: [publish-docker]

permissions: {}  # Minimal top-level for OSSF Scorecard Token-Permissions

jobs:
  build-amd64:
    name: Build AMD64 Image
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: read
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push AMD64 image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/local-deep-research:amd64-${{ github.sha }}
          cache-from: type=gha,scope=linux-amd64
          cache-to: type=gha,mode=max,scope=linux-amd64

  build-arm64:
    name: Build ARM64 Image
    runs-on: ubuntu-24.04-arm
    environment: release
    permissions:
      contents: read
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push ARM64 image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/local-deep-research:arm64-${{ github.sha }}
          cache-from: type=gha,scope=linux-arm64
          cache-to: type=gha,mode=max,scope=linux-arm64

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: read

    steps:
      - name: Check out the repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Free disk space
        run: |
          # Remove unnecessary packages to free up space for Docker build + Trivy scan
          # GitHub runners have limited space; Trivy needs to export the full image to /tmp
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo docker image prune --all --force || true
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Build Docker image for security scan
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: local-deep-research:security-scan
          cache-from: type=gha,scope=linux-amd64
          cache-to: type=gha,mode=max,scope=linux-amd64

      # Generate SARIF report for GitHub Security tab (all severities, doesn't fail)
      - name: Generate Trivy SARIF report
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # master
        with:
          image-ref: local-deep-research:security-scan
          format: 'sarif'
          output: 'trivy-release-scan.sarif'
          exit-code: '0'

      # Separate scan that fails build only on fixable HIGH/CRITICAL vulnerabilities
      - name: Check for fixable HIGH/CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # master
        with:
          image-ref: local-deep-research:security-scan
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true  # Only fail on vulnerabilities with available fixes
          trivyignores: '.trivyignore'  # Ignore bundled library CVEs that can't be fixed
          exit-code: '1'

      - name: Upload Trivy scan results from release
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        if: always()
        with:
          name: trivy-release-scan
          path: trivy-release-scan.sarif
          retention-days: 7  # Reduced for security

  create-manifest:
    name: Create Multi-Platform Manifest
    needs: [build-amd64, build-arm64, security-scan]
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: read
      id-token: write  # Required for Sigstore keyless signing
      packages: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@df199fb7be9f65074067a9eb93f12bb4c5547cf2 # v2.13.3
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@43a17d6e7add2b5535efe4dcae9952337c479a93 # v0.20.11

      - name: Determine version tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            TAG="${{ github.event.client_payload.tag }}"
          else
            TAG="${{ github.event.release.tag_name }}"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          # Extract version without 'v' prefix
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          # Extract major.minor
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)
          echo "major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@318604b99e75e41977312d83839a89be02ca4893 # v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/local-deep-research
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=${{ steps.version.outputs.major_minor }}
            type=raw,value=latest

      - name: Create and push multi-platform manifest
        id: manifest
        run: |
          # Get the tags from metadata (newline separated)
          TAGS="${{ steps.meta.outputs.tags }}"

          # Store first tag for attestation
          FIRST_TAG=$(echo "$TAGS" | head -n 1)
          echo "primary_tag=$FIRST_TAG" >> "$GITHUB_OUTPUT"

          # Create manifest for each tag
          echo "$TAGS" | while IFS= read -r tag; do
            if [ -n "$tag" ]; then
              echo "Creating manifest for: $tag"
              docker buildx imagetools create -t "$tag" \
                ${{ secrets.DOCKER_USERNAME }}/local-deep-research:amd64-${{ github.sha }} \
                ${{ secrets.DOCKER_USERNAME }}/local-deep-research:arm64-${{ github.sha }}
            fi
          done

      - name: Sign Docker images with Cosign
        env:
          TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          # Sign each image tag using keyless signing with GitHub OIDC
          echo "$TAGS" | while IFS= read -r tag; do
            if [ -n "$tag" ]; then
              echo "Signing image: $tag"
              cosign sign --yes "$tag"
            fi
          done

      - name: Generate SLSA provenance attestation
        env:
          PRIMARY_TAG: ${{ steps.manifest.outputs.primary_tag }}
        run: |
          # Generate SLSA provenance predicate
          # Note: SLSA spec requires "sha1" field name for git commit digest
          cat > provenance.json <<EOF
          {
            "buildType": "https://github.com/${{ github.repository }}/docker-build@v1",
            "builder": {
              "id": "https://github.com/actions/runner"
            },
            "invocation": {
              "configSource": {
                "uri": "https://github.com/${{ github.repository }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                },
                "entryPoint": ".github/workflows/docker-publish.yml"
              }
            },
            "metadata": {
              "buildInvocationId": "${{ github.run_id }}",
              "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "completeness": {
                "parameters": true,
                "environment": true,
                "materials": true
              },
              "reproducible": false
            },
            "materials": [
              {
                "uri": "https://github.com/${{ github.repository }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            ]
          }
          EOF

          # Attach provenance to image
          cosign attest --yes --predicate provenance.json --type slsaprovenance "$PRIMARY_TAG"

      - name: Verify image signature
        env:
          PRIMARY_TAG: ${{ steps.manifest.outputs.primary_tag }}
        run: |
          echo "Verifying signature for: $PRIMARY_TAG"
          cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            "$PRIMARY_TAG"

      - name: Attach SBOM to image
        env:
          PRIMARY_TAG: ${{ steps.manifest.outputs.primary_tag }}
        run: |
          # Generate SBOM using syft
          docker pull "$PRIMARY_TAG"
          syft "$PRIMARY_TAG" -o spdx-json > sbom.spdx.json

          # Attach SBOM to image
          cosign attach sbom --sbom sbom.spdx.json "$PRIMARY_TAG"

          # Sign the SBOM
          cosign sign --yes --attachment sbom "$PRIMARY_TAG"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

      - name: Clean up temporary tags
        run: |
          echo "Manifest creation complete. Temporary platform-specific tags can be removed manually if desired."
